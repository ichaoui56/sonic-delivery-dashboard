generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            Int            @id @default(autoincrement())
  name          String
  email         String         @unique
  phone         String?
  password      String
  role          Role           @default(MERCHANT)
  image         String?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  admin         Admin?
  deliveryMan   DeliveryMan?
  merchant      Merchant?
  notifications Notification[]
  
  @@index([email])
  @@index([role])
  @@index([createdAt(sort: Desc)])
  @@index([phone])
}

model Admin {
  id        Int      @id @default(autoincrement())
  userId    Int      @unique
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id])
}

model Merchant {
  id               Int               @id @default(autoincrement())
  userId           Int               @unique
  companyName      String?
  rib              String?
  bankName         String?
  balance          Float             @default(0)
  totalEarned      Float             @default(0)
  baseFee          Float             @default(0)
  createdAt        DateTime          @default(now())
  user             User              @relation(fields: [userId], references: [id])
  moneyTransfers   MoneyTransfer[]
  orders           Order[]
  products         Product[]
  productTransfers ProductTransfer[]
  
  @@index([userId])
  @@index([createdAt(sort: Desc)])
  @@index([companyName])
  @@index([balance])
}

model Product {
  id             Int            @id @default(autoincrement())
  merchantId     Int
  name           String
  description    String?
  image          String?
  sku            String?        @unique
  price          Float
  stockQuantity  Int            @default(0)
  deliveredCount Int            @default(0)
  lowStockAlert  Int            @default(3)
  isActive       Boolean        @default(true)
  createdAt      DateTime       @default(now())
  orderItems     OrderItem[]
  merchant       Merchant       @relation(fields: [merchantId], references: [id])
  TransferItem   TransferItem[]
  
  @@index([merchantId])
  @@index([merchantId, isActive])
  @@index([merchantId, stockQuantity])
  @@index([merchantId, deliveredCount])
  @@index([merchantId, isActive, stockQuantity])
  @@index([stockQuantity])
  @@index([isActive])
  @@index([createdAt(sort: Desc)])
  @@index([price])
  @@index([lowStockAlert])
  @@index([deliveredCount])
  @@index([merchantId, createdAt(sort: Desc)])
  @@index([name])
}

model ProductTransfer {
  id                     Int            @id @default(autoincrement())
  transferCode           String         @unique
  merchantId             Int
  deliveryCompany        String?
  trackingNumber         String?
  note                   String?
  status                 TransferStatus @default(PENDING)
  shippedAt              DateTime?
  deliveredToWarehouseAt DateTime?
  createdAt              DateTime       @default(now())
  updatedAt              DateTime       @updatedAt
  merchant               Merchant       @relation(fields: [merchantId], references: [id])
  transferItems          TransferItem[]
  
  @@index([merchantId])
  @@index([merchantId, createdAt(sort: Desc)])
  @@index([merchantId, status])
  @@index([status])
  @@index([trackingNumber])
  @@index([createdAt(sort: Desc)])
  @@index([deliveredToWarehouseAt])
  @@index([merchantId, status, createdAt(sort: Desc)])
}

model TransferItem {
  id         Int             @id @default(autoincrement())
  transferId Int
  productId  Int
  quantity   Int
  product    Product         @relation(fields: [productId], references: [id])
  transfer   ProductTransfer @relation(fields: [transferId], references: [id])
  
  @@index([transferId])
  @@index([productId])
  @@index([transferId, productId])
  @@index([quantity])
}

model Order {
  id                     Int               @id @default(autoincrement())
  orderCode              String            @unique
  customerName           String
  customerPhone          String
  address                String
  city                   String
  note                   String?
  totalPrice             Float
  paymentMethod          PaymentMethod     @default(COD)
  merchantEarning        Float
  status                 OrderStatus       @default(PENDING)
  merchantId             Int
  deliveryManId          Int?
  discountType           DiscountType?
  discountValue          Float?
  discountDescription    String?
  originalTotalPrice     Float?
  totalDiscount          Float?
  buyXGetYConfig         String?
  createdAt              DateTime          @default(now())
  deliveredAt            DateTime?
  updatedAt              DateTime          @updatedAt
  Notification           Notification[]
  deliveryAttemptHistory DeliveryAttempt[]
  deliveryMan            DeliveryMan?      @relation(fields: [deliveryManId], references: [id])
  merchant               Merchant          @relation(fields: [merchantId], references: [id])
  orderItems             OrderItem[]
  
  @@index([merchantId])
  @@index([merchantId, createdAt(sort: Desc)])
  @@index([merchantId, status])
  @@index([merchantId, status, createdAt(sort: Desc)])
  @@index([deliveryManId])
  @@index([deliveryManId, status])
  @@index([deliveryManId, status, createdAt(sort: Desc)])
  @@index([city])
  @@index([city, status])
  @@index([city, createdAt(sort: Desc)])
  @@index([status])
  @@index([createdAt(sort: Desc)])
  @@index([orderCode])
  @@index([customerPhone])
  @@index([paymentMethod])
  @@index([totalPrice])
  @@index([merchantEarning])
  @@index([deliveredAt])
  @@index([merchantId, paymentMethod, status])
  @@index([customerName])
  @@index([address])
}

model DeliveryAttempt {
  id            Int           @id @default(autoincrement())
  orderId       Int
  attemptNumber Int
  deliveryManId Int?
  attemptedAt   DateTime      @default(now())
  status        AttemptStatus
  reason        String?
  notes         String?
  location      String?
  deliveryMan   DeliveryMan?  @relation(fields: [deliveryManId], references: [id])
  order         Order         @relation(fields: [orderId], references: [id])

  @@unique([orderId, attemptNumber])
  @@index([orderId])
  @@index([deliveryManId])
  @@index([attemptedAt(sort: Desc)])
  @@index([orderId, attemptedAt(sort: Desc)])
  @@index([status])
  @@index([deliveryManId, attemptedAt(sort: Desc)])
}

model OrderItem {
  id            Int     @id @default(autoincrement())
  orderId       Int
  productId     Int
  quantity      Int
  price         Float
  originalPrice Float?
  isFree        Boolean @default(false)
  order         Order   @relation(fields: [orderId], references: [id])
  product       Product @relation(fields: [productId], references: [id])
  
  @@index([orderId])
  @@index([productId])
  @@index([orderId, productId])
  @@index([quantity])
  @@index([price])
  @@index([orderId, isFree])
  @@index([productId, orderId])
}

model DeliveryMan {
  id                   Int               @id @default(autoincrement())
  userId               Int               @unique
  vehicleType          String?
  city                 String?
  active               Boolean           @default(true)
  totalDeliveries      Int               @default(0)
  successfulDeliveries Int               @default(0)
  totalEarned          Float             @default(0)
  baseFee              Float             @default(0)
  rating               Float?
  createdAt            DateTime          @default(now())
  user                 User              @relation(fields: [userId], references: [id])
  assignedOrders       Order[]
  deliveryAttempts     DeliveryAttempt[]
  moneyTransfers       MoneyTransfer[]
  
  @@index([userId])
  @@index([city])
  @@index([city, active])
  @@index([active])
  @@index([createdAt(sort: Desc)])
  @@index([totalEarned])
  @@index([rating])
  @@index([city, active, createdAt(sort: Desc)])
}

model MoneyTransfer {
  id            Int          @id @default(autoincrement())
  merchantId    Int?
  deliveryManId Int?
  amount        Float
  transferDate  DateTime     @default(now())
  invoiceImage  String?
  reference     String?
  note          String?
  createdAt     DateTime     @default(now())
  merchant      Merchant?    @relation(fields: [merchantId], references: [id])
  deliveryMan   DeliveryMan? @relation(fields: [deliveryManId], references: [id])
  
  @@index([merchantId])
  @@index([merchantId, transferDate(sort: Desc)])
  @@index([deliveryManId])
  @@index([deliveryManId, transferDate(sort: Desc)])
  @@index([transferDate(sort: Desc)])
  @@index([amount])
  @@index([merchantId, amount, transferDate(sort: Desc)])
  @@index([deliveryManId, amount, transferDate(sort: Desc)])
}

model Notification {
  id        Int      @id @default(autoincrement())
  title     String
  message   String
  type      String
  isRead    Boolean  @default(false)
  userId    Int
  orderId   Int?
  createdAt DateTime @default(now())
  order     Order?   @relation(fields: [orderId], references: [id])
  user      User     @relation(fields: [userId], references: [id])
  
  @@index([userId])
  @@index([userId, isRead])
  @@index([userId, createdAt(sort: Desc)])
  @@index([orderId])
  @@index([isRead])
  @@index([createdAt(sort: Desc)])
  @@index([type])
  @@index([userId, isRead, createdAt(sort: Desc)])
}

enum Role {
  ADMIN
  MERCHANT
  DELIVERYMAN
}

enum OrderStatus {
  PENDING
  ACCEPTED
  ASSIGNED_TO_DELIVERY
  DELIVERED
  REPORTED
  REJECTED
  CANCELLED
}

enum PaymentMethod {
  COD
  PREPAID
}

enum TransferStatus {
  PENDING
  IN_TRANSIT
  DELIVERED_TO_WAREHOUSE
  CANCELLED
}

enum AttemptStatus {
  ATTEMPTED
  FAILED
  SUCCESSFUL
  CUSTOMER_NOT_AVAILABLE
  WRONG_ADDRESS
  REFUSED
  OTHER
}

enum DiscountType {
  PERCENTAGE
  FIXED_AMOUNT
  BUY_X_GET_Y
  CUSTOM_PRICE
}