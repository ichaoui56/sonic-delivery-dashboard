generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            Int            @id @default(autoincrement())
  name          String
  email         String         @unique
  phone         String?
  password      String
  role          Role           @default(MERCHANT)
  image         String?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  admin         Admin?
  deliveryMan   DeliveryMan?
  merchant      Merchant?
  notifications Notification[]
}

model Admin {
  id        Int      @id @default(autoincrement())
  userId    Int      @unique
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id])
}

model Merchant {
  id               Int               @id @default(autoincrement())
  userId           Int               @unique
  companyName      String?
  rib              String?
  bankName         String?
  balance          Float             @default(0)
  totalEarned      Float             @default(0)
  baseFee          Float             @default(0)
  createdAt        DateTime          @default(now())
  user             User              @relation(fields: [userId], references: [id])
  moneyTransfers   MoneyTransfer[]
  orders           Order[]
  products         Product[]
  productTransfers ProductTransfer[]
}

model Product {
  id             Int            @id @default(autoincrement())
  merchantId     Int
  name           String
  description    String?
  image          String?
  sku            String?        @unique
  price          Float
  stockQuantity  Int            @default(0)
  deliveredCount Int            @default(0)
  lowStockAlert  Int            @default(3)
  isActive       Boolean        @default(true)
  createdAt      DateTime       @default(now())
  orderItems     OrderItem[]
  merchant       Merchant       @relation(fields: [merchantId], references: [id])
  TransferItem   TransferItem[]
}

model ProductTransfer {
  id                     Int            @id @default(autoincrement())
  transferCode           String         @unique
  merchantId             Int
  deliveryCompany        String?
  trackingNumber         String?
  note                   String?
  status                 TransferStatus @default(PENDING)
  shippedAt              DateTime?
  deliveredToWarehouseAt DateTime?
  createdAt              DateTime       @default(now())
  updatedAt              DateTime       @updatedAt
  merchant               Merchant       @relation(fields: [merchantId], references: [id])
  transferItems          TransferItem[]
}

model TransferItem {
  id         Int             @id @default(autoincrement())
  transferId Int
  productId  Int
  quantity   Int
  product    Product         @relation(fields: [productId], references: [id])
  transfer   ProductTransfer @relation(fields: [transferId], references: [id])
}

model Order {
  id                     Int               @id @default(autoincrement())
  orderCode              String            @unique
  customerName           String
  customerPhone          String
  address                String
  city                   String
  note                   String?
  totalPrice             Float
  paymentMethod          PaymentMethod     @default(COD)
  merchantEarning        Float
  status                 OrderStatus       @default(PENDING)
  merchantId             Int
  deliveryManId          Int?
  discountType           DiscountType?     // Type of discount applied
  discountValue          Float?            // Percentage or fixed amount value
  discountDescription    String?           // Merchant's description of the promotion
  originalTotalPrice     Float?            // Original price before discount
  totalDiscount          Float?            // Total discount amount applied
  buyXGetYConfig         String?           // JSON string for buy X get Y rules
  // </CHANGE>
  createdAt              DateTime          @default(now())
  deliveredAt            DateTime?
  updatedAt              DateTime          @updatedAt
  Notification           Notification[]
  deliveryAttemptHistory DeliveryAttempt[]
  deliveryMan            DeliveryMan?      @relation(fields: [deliveryManId], references: [id])
  merchant               Merchant          @relation(fields: [merchantId], references: [id])
  orderItems             OrderItem[]
}

model DeliveryAttempt {
  id            Int           @id @default(autoincrement())
  orderId       Int
  attemptNumber Int
  deliveryManId Int?
  attemptedAt   DateTime      @default(now())
  status        AttemptStatus
  reason        String?
  notes         String?
  location      String?
  deliveryMan   DeliveryMan?  @relation(fields: [deliveryManId], references: [id])
  order         Order         @relation(fields: [orderId], references: [id])

  @@unique([orderId, attemptNumber])
}

model OrderItem {
  id        Int     @id @default(autoincrement())
  orderId   Int
  productId Int
  quantity  Int
  price     Float
  originalPrice Float? // Price before discount
  isFree        Boolean @default(false) // Mark free items from promotions
  // </CHANGE>
  order     Order   @relation(fields: [orderId], references: [id])
  product   Product @relation(fields: [productId], references: [id])
}

model DeliveryMan {
  id                   Int               @id @default(autoincrement())
  userId               Int               @unique
  vehicleType          String?
  city                 String?
  active               Boolean           @default(true)
  totalDeliveries      Int               @default(0)
  successfulDeliveries Int               @default(0)
  totalEarned          Float             @default(0)
  baseFee              Float             @default(0)
  rating               Float?
  createdAt            DateTime          @default(now())
  user                 User              @relation(fields: [userId], references: [id])
  assignedOrders       Order[]
  deliveryAttempts     DeliveryAttempt[]
  moneyTransfers       MoneyTransfer[]
}

model MoneyTransfer {
  id            Int          @id @default(autoincrement())
  merchantId    Int?
  deliveryManId Int?
  amount        Float
  transferDate  DateTime     @default(now())
  invoiceImage  String?
  reference     String?
  note          String?
  createdAt     DateTime     @default(now())
  merchant      Merchant?    @relation(fields: [merchantId], references: [id])
  deliveryMan   DeliveryMan? @relation(fields: [deliveryManId], references: [id])
}

model Notification {
  id        Int      @id @default(autoincrement())
  title     String
  message   String
  type      String
  isRead    Boolean  @default(false)
  userId    Int
  orderId   Int?
  createdAt DateTime @default(now())
  order     Order?   @relation(fields: [orderId], references: [id])
  user      User     @relation(fields: [userId], references: [id])
}

enum Role {
  ADMIN
  MERCHANT
  DELIVERYMAN
}

enum OrderStatus {
  PENDING
  ACCEPTED
  ASSIGNED_TO_DELIVERY
  DELIVERED
  REPORTED
  REJECTED
  CANCELLED
}

enum PaymentMethod {
  COD
  PREPAID
}

enum TransferStatus {
  PENDING
  IN_TRANSIT
  DELIVERED_TO_WAREHOUSE
  CANCELLED
}

enum AttemptStatus {
  ATTEMPTED
  FAILED
  SUCCESSFUL
  CUSTOMER_NOT_AVAILABLE
  WRONG_ADDRESS
  REFUSED
  OTHER
}

enum DiscountType {
  PERCENTAGE       // e.g., 10% off
  FIXED_AMOUNT     // e.g., 50 MAD off
  BUY_X_GET_Y      // e.g., Buy 2 Get 1 Free
  CUSTOM_PRICE     // Manual price override
}
